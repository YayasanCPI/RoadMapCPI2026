<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPI Foundation - Cloud Connected</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        cpi: {
                            50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e',
                        },
                        gold: { 500: '#d97706', 600: '#b45309' }
                    }
                }
            }
        }
    </script>

    <style>
        .drive-frame { width: 100%; height: 100%; border: none; background-color: #f8fafc; }
        .nav-btn.active { background-color: #0369a1; color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .nav-btn:not(.active) { background-color: transparent; color: #64748b; }
        .nav-btn:not(.active):hover { background-color: #f1f5f9; color: #334155; }
        .folder-item.active { background-color: #e0f2fe; color: #0369a1; border-right: 3px solid #0369a1; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .edit-input { width: 100%; border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; }
        .edit-input:focus { outline: none; border-color: #0369a1; ring: 2px solid #e0f2fe; }
        
        /* Loading Overlay */
        #cloud-loader { backdrop-filter: blur(4px); background-color: rgba(255,255,255,0.7); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased h-screen flex flex-col overflow-hidden">

    <!-- Cloud Loader Overlay -->
    <div id="cloud-loader" class="fixed inset-0 z-[60] flex flex-col items-center justify-center hidden">
        <div class="w-16 h-16 border-4 border-cpi-200 border-t-cpi-700 rounded-full animate-spin mb-4"></div>
        <h3 class="font-bold text-cpi-900 text-lg">Menyinkronkan Data...</h3>
        <p class="text-sm text-slate-500">Menghubungkan ke Google Sheets</p>
    </div>

    <!-- TOP NAVBAR -->
    <nav class="bg-white border-b border-slate-200 z-40 h-16 flex-none shadow-sm">
        <div class="max-w-full px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between items-center h-full">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-auto flex items-center justify-center">
                        <img src="https://i.ibb.co.com/KxWySDqp/logo-cpi.png" alt="Logo CPI" class="h-10 w-auto object-contain" onerror="this.src='https://ui-avatars.com/api/?name=CPI+F&background=0369a1&color=fff&size=128';">
                    </div>
                    <div class="leading-tight hidden sm:block">
                        <h1 class="font-bold text-lg text-slate-900 tracking-tight">CPI Foundation</h1>
                        <p class="text-[10px] font-bold tracking-widest text-gold-600 uppercase">Cloud System 2026</p>
                    </div>
                </div>
                <div class="hidden md:flex bg-slate-100 p-1 rounded-lg gap-1">
                    <button onclick="switchView('dashboard')" id="btn-dashboard" class="nav-btn active px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2">
                        <i class="fas fa-chart-pie"></i> Executive Dashboard
                    </button>
                    <button onclick="switchView('roadmap')" id="btn-roadmap" class="nav-btn px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2">
                        <i class="fas fa-calendar-check"></i> Roadmap & Edit
                    </button>
                    <button onclick="switchView('drive')" id="btn-drive" class="nav-btn px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2">
                        <i class="fab fa-google-drive"></i> Arsip Drive
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Status Indicator -->
                    <div id="status-indicator" class="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded border border-yellow-200" title="Status Koneksi">
                        <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                        <span class="text-[10px] font-bold text-yellow-700">Connecting...</span>
                    </div>
                    <button onclick="forceSync()" class="text-[10px] bg-cpi-100 text-cpi-700 px-2 py-1 rounded hover:bg-cpi-200 transition" title="Sync Manual">
                        <i class="fas fa-sync"></i>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden border border-slate-300">
                        <img src="https://ui-avatars.com/api/?name=Admin+CPI&background=0c4a6e&color=fff" alt="Profile">
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="flex-1 relative overflow-hidden bg-slate-50">

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-dashboard" class="absolute inset-0 overflow-y-auto p-6 transition-opacity duration-300 z-20 bg-slate-50">
            <div class="max-w-6xl mx-auto space-y-6">
                <div class="bg-gradient-to-r from-cpi-800 to-cpi-600 rounded-xl p-6 text-white shadow-lg flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold mb-1">Status Strategis 2026</h2>
                        <p class="text-cpi-100 text-sm max-w-2xl">
                            Data terhubung dengan <strong>Google Sheets Database</strong>. Perubahan di sini akan langsung tersimpan di cloud.
                        </p>
                    </div>
                    <div class="text-right flex flex-col items-end gap-2">
                        <a href="https://docs.google.com/spreadsheets/d/1Mkg-0YdozdgmzQyP4PoI2VEFknniY9eabLciOuzKR_c/edit" target="_blank" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded text-xs font-bold backdrop-blur-sm transition flex items-center gap-2">
                            <i class="fas fa-table"></i> Buka Database Sheet
                        </a>
                        <div class="hidden md:block">
                            <p class="text-xs text-cpi-200">Last Sync</p>
                            <p class="font-mono font-bold" id="lastUpdate">-</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-cpi-500">
                        <div class="flex justify-between items-start">
                            <div class="text-xs text-slate-500 uppercase font-bold">Total Program</div>
                            <i class="fas fa-clipboard-list text-cpi-200"></i>
                        </div>
                        <div class="text-3xl font-bold text-cpi-700 mt-2" id="statTotal">...</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-gold-500">
                        <div class="flex justify-between items-start">
                            <div class="text-xs text-slate-500 uppercase font-bold">Estimasi RAB</div>
                            <i class="fas fa-coins text-gold-200"></i>
                        </div>
                        <div class="text-2xl font-bold text-gold-600 mt-2 tracking-tight" id="statBudget">...</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-emerald-500">
                        <div class="flex justify-between items-start">
                            <div class="text-xs text-slate-500 uppercase font-bold">Rata-rata</div>
                            <i class="fas fa-chart-line text-emerald-200"></i>
                        </div>
                        <div class="text-xl font-bold text-emerald-600 mt-2" id="statAvg">...</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-purple-500">
                        <div class="flex justify-between items-start">
                            <div class="text-xs text-slate-500 uppercase font-bold">Pilar Dominan</div>
                            <i class="fas fa-star text-purple-200"></i>
                        </div>
                        <div class="text-xl font-bold text-purple-600 mt-2" id="statDominant">...</div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-80">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">Sebaran Program per Pilar</h3>
                        <div class="relative h-64 w-full"><canvas id="pillarChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-80">
                        <h3 class="font-bold text-slate-700 mb-4 text-sm uppercase">Timeline Kegiatan</h3>
                        <div class="relative h-64 w-full"><canvas id="monthlyChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: ROADMAP -->
        <div id="view-roadmap" class="absolute inset-0 overflow-y-auto p-6 transition-opacity duration-300 z-10 opacity-0 pointer-events-none bg-slate-50">
            <div class="max-w-7xl mx-auto space-y-8 pb-12">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-slate-200 pb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                            <i class="fas fa-edit text-cpi-600"></i> Editor Program & RAB
                        </h2>
                        <p class="text-slate-500 mt-1 text-sm">Update data di sini akan menyinkronkan Google Sheet secara otomatis.</p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="filterProgram('all')" class="px-3 py-1 text-xs font-bold rounded-full bg-slate-800 text-white shadow transition">Semua</button>
                        <button onclick="filterProgram('Pendidikan')" class="px-3 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition">Pendidikan</button>
                        <button onclick="filterProgram('Kesehatan')" class="px-3 py-1 text-xs font-bold rounded-full bg-rose-100 text-rose-700 hover:bg-rose-200 transition">Kesehatan</button>
                        <button onclick="filterProgram('Lingkungan')" class="px-3 py-1 text-xs font-bold rounded-full bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition">Lingkungan</button>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="programGrid"></div>
            </div>
        </div>

        <!-- VIEW 3: DRIVE -->
        <div id="view-drive" class="absolute inset-0 flex transition-opacity duration-300 z-10 opacity-0 pointer-events-none bg-slate-50">
            <aside class="w-64 md:w-72 bg-white border-r border-slate-200 flex flex-col h-full shadow-lg z-20 flex-none">
                <div class="p-4 border-b border-slate-100 bg-slate-50">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Direktori Arsip</h2>
                </div>
                <div class="flex-1 overflow-y-auto py-2 space-y-1" id="driveSidebar"></div>
            </aside>
            <main class="flex-1 flex flex-col bg-slate-100 h-full relative">
                <div class="h-12 bg-white border-b border-slate-200 flex justify-between items-center px-4 flex-none">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-folder-open text-yellow-500"></i>
                        <span id="driveFolderTitle" class="font-bold text-xs md:text-sm text-slate-700">Memuat...</span>
                    </div>
                    <a id="driveExternalLink" href="#" target="_blank" class="text-xs font-bold text-cpi-600 hover:underline">
                        <i class="fas fa-external-link-alt mr-1"></i> Buka Tab Baru
                    </a>
                </div>
                <div class="flex-1 relative bg-slate-50">
                    <div id="driveLoader" class="absolute inset-0 flex items-center justify-center z-0">
                        <div class="text-center animate-pulse">
                            <i class="fab fa-google-drive text-4xl text-slate-300"></i>
                            <p class="text-xs text-slate-400 mt-2">Memuat Folder...</p>
                        </div>
                    </div>
                    <iframe id="driveFrame" class="drive-frame relative z-10" src=""></iframe>
                </div>
            </main>
        </div>

        <!-- MODAL EDIT -->
        <div id="programModal" class="fixed inset-0 z-50 hidden opacity-0 pointer-events-none flex items-center justify-center bg-black/50 backdrop-blur-sm modal">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform transition-all scale-95 flex flex-col max-h-[90vh]" id="modalContent">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 flex-none">
                    <div id="header-view" class="w-full">
                        <h3 class="font-bold text-lg text-slate-800 leading-tight" id="modalTitle">Judul Program</h3>
                    </div>
                    <div id="header-edit" class="w-full hidden">
                        <input type="text" id="editTitle" class="edit-input font-bold text-lg" placeholder="Judul Program">
                    </div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 transition ml-4"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="p-6 overflow-y-auto space-y-6 flex-1">
                    <div id="content-view" class="space-y-6">
                        <div class="flex gap-2 mb-2" id="modalTags"></div>
                        <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-100">
                            <h4 class="text-xs font-bold uppercase text-blue-800 mb-2 tracking-wider">Latar Belakang</h4>
                            <p class="text-sm text-slate-600 leading-relaxed" id="modalDesc">Deskripsi...</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 border border-slate-200 rounded-lg">
                                <div class="text-xs text-slate-400 uppercase font-bold mb-1">Target KPI</div>
                                <div class="font-semibold text-slate-800 text-sm" id="modalKPI">-</div>
                            </div>
                            <div class="p-3 border border-slate-200 rounded-lg bg-yellow-50 border-yellow-100">
                                <div class="text-xs text-yellow-700 uppercase font-bold mb-1">Estimasi RAB</div>
                                <div class="font-semibold text-yellow-800 text-sm" id="modalRAB">Rp 0</div>
                            </div>
                            <div class="p-3 border border-slate-200 rounded-lg">
                                <div class="text-xs text-slate-400 uppercase font-bold mb-1">PIC</div>
                                <div class="font-semibold text-slate-800 text-sm" id="modalPIC">-</div>
                            </div>
                            <div class="p-3 border border-slate-200 rounded-lg">
                                <div class="text-xs text-slate-400 uppercase font-bold mb-1">Lokasi</div>
                                <div class="font-semibold text-slate-800 text-sm" id="modalLoc">-</div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 mb-3 text-sm border-b pb-1">Tahapan Eksekusi</h4>
                            <ul class="space-y-3" id="modalSteps"></ul>
                        </div>
                    </div>
                    <div id="content-edit" class="space-y-4 hidden">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Deskripsi</label><textarea id="editDesc" rows="4" class="edit-input"></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">KPI</label><input type="text" id="editKPI" class="edit-input"></div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">RAB (Rp)</label>
                                <input type="text" id="editRAB" class="edit-input font-mono font-bold text-yellow-700" placeholder="Contoh: 50.000.000">
                                <p class="text-[10px] text-slate-400">Masukkan angka saja atau format "Rp ...".</p>
                            </div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">PIC</label><input type="text" id="editPIC" class="edit-input"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Lokasi</label><input type="text" id="editLoc" class="edit-input"></div>
                        </div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Tahapan (Baris baru per langkah)</label><textarea id="editSteps" rows="5" class="edit-input"></textarea></div>
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center flex-none">
                    <span class="text-[10px] text-slate-400 italic" id="edit-hint">*Tersimpan ke Google Sheets.</span>
                    <div class="flex gap-2">
                        <button id="btn-cancel" onclick="toggleEditMode(false)" class="px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-200 rounded transition hidden">Batal</button>
                        <button id="btn-edit" onclick="toggleEditMode(true)" class="px-4 py-2 text-sm font-bold bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 rounded transition shadow-sm"><i class="fas fa-edit mr-2"></i> Edit Data</button>
                        <button id="btn-save" onclick="saveChanges()" class="px-4 py-2 text-sm font-bold bg-green-600 text-white hover:bg-green-700 rounded transition shadow hidden"><i class="fas fa-save mr-2"></i> Simpan ke Cloud</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ================= CONFIGURATION =================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxt87Vpeg8rhvf0cRj22-N95qGAshGt5J3sqceEUkAnnQJUmnIBY-T2yarIH646zWCC/exec"; 
        
        // --- DEFAULT DATA (Strategic 2026) ---
        const fallbackData = [
            { id: 1, month: 'Januari', date: '17 Jan (Sabtu)', title: 'Webinar: Safety Begins at Home', pillar: 'Kesehatan', color: 'rose', desc: 'Pelatihan K3 listrik & P3K rumah tangga.', kpi: '50 Keluarga Alumni.', rab: 'Rp 5.000.000', pic: 'Divisi Safety', loc: 'Online', steps: ['Rekrutmen Pemateri', 'Siapkan Alat Demo'] },
            { id: 2, month: 'Februari', date: '21 Feb (Sabtu)', title: 'Kampanye Zero Waste Mining Family', pillar: 'Lingkungan', color: 'emerald', desc: 'Edukasi pemilahan sampah organik.', kpi: '30 Keluarga Pilot Project.', rab: 'Rp 3.000.000', pic: 'Divisi Lingkungan', loc: 'Online', steps: ['Desain Materi', 'Challenge Medsos'] },
            { id: 3, month: 'Maret', date: 'Awal Mar', title: 'Charity Ramadhan & Air Bersih', pillar: 'Sosial', color: 'rose', desc: 'Bantuan air bersih & sembako.', kpi: '1 Instalasi Air, 200 Sembako.', rab: 'Rp 80.000.000', pic: 'Divisi Sosial', loc: 'Desa Binaan', steps: ['Survey Lokasi', 'Eksekusi'] },
            { id: 4, month: 'April', date: '22 Apr (Rabu)', title: 'Launching Beasiswa Anak Tambang', pillar: 'Pendidikan', color: 'blue', desc: 'Beasiswa khusus peduli lingkungan.', kpi: '50 Pendaftar.', rab: 'Rp 5.000.000', pic: 'Divisi Pendidikan', loc: 'Online', steps: ['Finalisasi Pedoman', 'Blast Info'] },
            { id: 5, month: 'Mei', date: '02 Mei', title: 'Mining Goes to School', pillar: 'Pendidikan', color: 'blue', desc: 'Alumni mengajar di sekolah.', kpi: '3 Sekolah.', rab: 'Rp 10.000.000', pic: 'Divisi Pendidikan', loc: 'Sekolah Mitra', steps: ['Hubungi Sekolah', 'Roadshow'] },
            { id: 6, month: 'Juni', date: '07 Jun (Minggu)', title: 'Coastal Clean Up', pillar: 'Lingkungan', color: 'emerald', desc: 'Bersih pantai di Hari Lingkungan Hidup.', kpi: '500kg Sampah.', rab: 'Rp 15.000.000', pic: 'Divisi Lingkungan', loc: 'Pesisir', steps: ['Perizinan', 'Aksi'] },
            { id: 7, month: 'Juli', date: '18 Jul', title: 'Distribusi Beasiswa & Gizi', pillar: 'Pendidikan', color: 'blue', desc: 'Penyerahan beasiswa & paket gizi.', kpi: '20 Beasiswa, 100 Gizi.', rab: 'Rp 70.000.000', pic: 'Pendidikan & Kes', loc: 'Sekretariat', steps: ['Data Final', 'Seremonial'] },
            { id: 8, month: 'Agustus', date: '16 Agu', title: 'Donor Darah Merdeka', pillar: 'Kesehatan', color: 'rose', desc: 'Aksi donor darah HUT RI.', kpi: '75 Kantong.', rab: 'Rp 7.500.000', pic: 'Divisi Kesehatan', loc: 'PMI Center', steps: ['Booking PMI', 'Pelaksanaan'] },
            { id: 9, month: 'September', date: '26 Sep', title: 'Gala Dinner: Mining for Life', pillar: 'Internal', color: 'slate', desc: 'Fundraising utama Hari Pertambangan.', kpi: 'Rp 1 Milyar Terkumpul.', rab: 'Rp 200.000.000', pic: 'Fundraising', loc: 'Hotel Jkt', steps: ['Konsep', 'Undangan'] },
            { id: 10, month: 'Oktober', date: '10 Okt', title: 'Webinar Mental Health', pillar: 'Kesehatan', color: 'rose', desc: 'Isu mental pekerja roster.', kpi: '150 Peserta.', rab: 'Rp 3.000.000', pic: 'Divisi Kesehatan', loc: 'Zoom', steps: ['Cari Psikolog', 'Webinar'] },
            { id: 11, month: 'November', date: '28 Nov', title: 'The Great Planting', pillar: 'Lingkungan', color: 'emerald', desc: 'Tanam pohon musim hujan.', kpi: '1000 Pohon.', rab: 'Rp 50.000.000', pic: 'Divisi Lingkungan', loc: 'Lahan Kritis', steps: ['Cari Lahan', 'Tanam'] },
            { id: 12, month: 'Desember', date: '05 Des', title: 'Volunteer Appreciation', pillar: 'Internal', color: 'slate', desc: 'Awarding relawan.', kpi: 'Awarding Night.', rab: 'Rp 20.000.000', pic: 'Sekretariat', loc: 'Sekretariat', steps: ['Hitung Poin', 'Syukuran'] }
        ];

        let programKerja = [];
        let currentEditId = null;

        const driveFolders = [
            { id: '1Sz2agx1xvHRoEhAcC49VQdd7PoHFEKNL', name: '00_LEGALITAS', label: 'Corporate Legal', icon: 'fa-balance-scale' },
            { id: '1jcZl0QggxXLe2QGP0QW_hheb-wD9NMGR', name: '01_TATA_KELOLA', label: 'Governance', icon: 'fa-sitemap' },
            { id: '16_CeR7Af7G4XD96Fklg19Ke_9cwTg3A1', name: '02_PROGRAM_KERJA', label: 'Center of Excellence', icon: 'fa-briefcase' },
            { id: '1QhOoFYmzzMkW_nQTFs5pLOoIegi8EmU-', name: '03_KEUANGAN', label: 'Finance', icon: 'fa-chart-line' },
            { id: '1QhQBtvV57A8zSJSnZsB5EWKHb1MhXx7w', name: '04_KESEKRETARIATAN', label: 'Admin & HR', icon: 'fa-user-tie' },
            { id: '1mxXAXIkZzwSj1-CHGPfaEtL7TYZepl2d', name: '05_MEDIA_BRANDING', label: 'Publikasi', icon: 'fa-bullhorn' }
        ];

        // --- INIT & SYNC LOGIC ---
        window.addEventListener('DOMContentLoaded', () => {
            fetchData(); // Try load from Cloud
            renderDriveSidebar();
        });

        async function fetchData() {
            showLoader(true);
            setStatus('Connecting...', 'yellow');
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                if(data && data.length > 0) {
                    programKerja = data;
                    setStatus('Online', 'green');
                } else {
                    // Jika sheet kosong, gunakan data fallback & inisialisasi sheet
                    programKerja = fallbackData;
                    setStatus('Offline / Initial', 'gray');
                    forceSync(); // Auto-seed data if empty
                }
            } catch (e) {
                console.warn("Gagal fetch dari Sheet, gunakan fallback/local.", e);
                const local = localStorage.getItem('cpi_cloud_backup');
                programKerja = local ? JSON.parse(local) : fallbackData;
                setStatus('Offline Mode', 'red');
            } finally {
                refreshUI();
                showLoader(false);
            }
        }

        async function saveDataToCloud() {
            showLoader(true);
            setStatus('Syncing...', 'yellow');
            try {
                // Save to Local Backup first
                localStorage.setItem('cpi_cloud_backup', JSON.stringify(programKerja));

                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Mode no-cors wajib untuk simple POST ke GAS
                    headers: { 'Content-Type': 'application/json' }, // Changed to application/json for better GAS parsing
                    body: JSON.stringify(programKerja)
                });
                
                setStatus('Online', 'green');
                refreshUI();
                const now = new Date();
                document.getElementById('lastUpdate').innerText = now.toLocaleTimeString('id-ID');
                
            } catch (e) {
                alert("Gagal mengirim ke Google Sheets. Data tersimpan di browser sementara.");
                console.error(e);
                setStatus('Sync Error', 'red');
            } finally {
                showLoader(false);
            }
        }
        
        function forceSync() {
            if(confirm("Kirim ulang semua data lokal ke Google Sheets?")) {
                saveDataToCloud();
            }
        }

        function refreshUI() {
            updateDashboard();
            renderRoadmap(programKerja);
        }

        function showLoader(show) {
            const el = document.getElementById('cloud-loader');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }
        
        function setStatus(text, color) {
            const el = document.getElementById('status-indicator');
            const dot = el.querySelector('div');
            const txt = el.querySelector('span');
            
            el.className = `flex items-center gap-1 bg-${color}-50 px-2 py-1 rounded border border-${color}-200`;
            dot.className = `w-2 h-2 rounded-full bg-${color}-500 ${color === 'yellow' || color === 'green' ? 'animate-pulse' : ''}`;
            txt.className = `text-[10px] font-bold text-${color}-700`;
            txt.innerText = text;
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            const total = programKerja.length;
            document.getElementById('statTotal').innerText = total;

            let totalBudget = 0;
            const pillarCounts = {};
            
            programKerja.forEach(p => {
                const cleanRAB = String(p.rab).replace(/[^0-9]/g, '');
                totalBudget += (parseInt(cleanRAB) || 0);
                const pillar = p.pillar === 'Sosial' ? 'Kesehatan' : p.pillar;
                pillarCounts[pillar] = (pillarCounts[pillar] || 0) + 1;
            });

            const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 });
            document.getElementById('statBudget').innerText = formatter.format(totalBudget);
            document.getElementById('statAvg').innerText = formatter.format(total > 0 ? totalBudget/total : 0);

            let maxPillar = '-'; let maxCount = 0;
            for (const [key, value] of Object.entries(pillarCounts)) {
                if (value > maxCount) { maxCount = value; maxPillar = key; }
            }
            document.getElementById('statDominant').innerText = maxPillar;
            updateCharts(pillarCounts, programKerja);
        }

        function updateCharts(counts, data) {
            const ctx1 = document.getElementById('pillarChart').getContext('2d');
            if(window.pillarChart instanceof Chart) window.pillarChart.destroy();
            const safeCounts = { 'Pendidikan': 0, 'Lingkungan': 0, 'Kesehatan': 0, 'Internal': 0 };
            Object.keys(counts).forEach(k => safeCounts[k] = counts[k]);

            window.pillarChart = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: ['Pendidikan', 'Lingkungan', 'Kesehatan', 'Internal'], datasets: [{ data: Object.values(safeCounts), backgroundColor: ['#3b82f6', '#10b981', '#f43f5e', '#64748b'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            const monthCounts = Array(12).fill(0);
            data.forEach(p => {
                const mIndex = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'].indexOf(p.month);
                if(mIndex >= 0) monthCounts[mIndex]++;
            });

            const ctx2 = document.getElementById('monthlyChart').getContext('2d');
            if(window.monthlyChart instanceof Chart) window.monthlyChart.destroy();
            window.monthlyChart = new Chart(ctx2, {
                type: 'bar',
                data: { labels: months, datasets: [{ label: 'Kegiatan', data: monthCounts, backgroundColor: '#0369a1', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false } } }
            });
        }

        // --- ROADMAP & EDIT ---
        function renderRoadmap(data) {
            const container = document.getElementById('programGrid');
            const colorMap = { 'Pendidikan': 'blue', 'Kesehatan': 'rose', 'Lingkungan': 'emerald', 'Internal': 'slate', 'Sosial': 'rose' };
            container.innerHTML = data.map(item => {
                const c = colorMap[item.pillar] || 'slate';
                return `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition cursor-pointer group flex flex-col h-full" onclick="openProgramDetail(${item.id})">
                    <div class="h-2 w-full bg-${c}-500 rounded-t-xl"></div>
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs font-bold uppercase tracking-wider text-slate-400 bg-slate-50 px-2 py-1 rounded border border-slate-100">${item.month}</span>
                            <span class="text-[10px] font-bold text-${c}-600 bg-${c}-50 px-2 py-1 rounded-full uppercase">${item.pillar}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 text-lg mb-2 group-hover:text-cpi-600 transition leading-snug">${item.title}</h3>
                        <div class="flex items-center gap-2 text-xs text-slate-500 mb-4"><i class="far fa-calendar-alt"></i> ${item.date}</div>
                        <p class="text-sm text-slate-600 line-clamp-2 mb-4 flex-1">${item.desc}</p>
                        <div class="pt-4 border-t border-slate-100 flex justify-between items-center mt-auto">
                            <span class="text-xs font-bold text-slate-400">Detail & RAB</span>
                            <i class="fas fa-arrow-right text-slate-300 group-hover:text-cpi-600 transition"></i>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function openProgramDetail(id) {
            currentEditId = id;
            const data = programKerja.find(p => p.id === id);
            if(!data) return;
            const c = { 'Pendidikan': 'blue', 'Kesehatan': 'rose', 'Lingkungan': 'emerald', 'Internal': 'slate', 'Sosial': 'rose' }[data.pillar];
            
            // View
            document.getElementById('modalTitle').innerText = data.title;
            document.getElementById('modalDesc').innerText = data.desc;
            document.getElementById('modalKPI').innerText = data.kpi;
            document.getElementById('modalRAB').innerText = data.rab;
            document.getElementById('modalPIC').innerText = data.pic;
            document.getElementById('modalLoc').innerText = data.loc;
            document.getElementById('modalTags').innerHTML = `<span class="px-2 py-1 bg-${c}-100 text-${c}-700 rounded text-xs font-bold uppercase">${data.pillar}</span>`;
            document.getElementById('modalSteps').innerHTML = (data.steps || []).map((s, i) => `<li class="flex gap-3 items-start text-sm text-slate-600"><span class="flex-none w-5 h-5 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs font-bold border border-slate-200">${i+1}</span><span>${s}</span></li>`).join('');

            // Edit
            document.getElementById('editTitle').value = data.title;
            document.getElementById('editDesc').value = data.desc;
            document.getElementById('editKPI').value = data.kpi;
            document.getElementById('editRAB').value = data.rab;
            document.getElementById('editPIC').value = data.pic;
            document.getElementById('editLoc').value = data.loc;
            document.getElementById('editSteps').value = (data.steps || []).join('\n');

            toggleEditMode(false);
            const modal = document.getElementById('programModal');
            modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
            modal.querySelector('#modalContent').classList.remove('scale-95');
            modal.querySelector('#modalContent').classList.add('scale-100');
            document.body.classList.add('modal-active');
        }

        function saveChanges() {
            if (currentEditId === null) return;
            const index = programKerja.findIndex(p => p.id === currentEditId);
            if (index !== -1) {
                programKerja[index].title = document.getElementById('editTitle').value;
                programKerja[index].desc = document.getElementById('editDesc').value;
                programKerja[index].kpi = document.getElementById('editKPI').value;
                programKerja[index].rab = document.getElementById('editRAB').value;
                programKerja[index].pic = document.getElementById('editPIC').value;
                programKerja[index].loc = document.getElementById('editLoc').value;
                programKerja[index].steps = document.getElementById('editSteps').value.split('\n').filter(s => s.trim() !== '');
                
                openProgramDetail(currentEditId);
                saveDataToCloud(); // Save to Google Sheet
            }
        }

        // --- UTILS ---
        function switchView(viewName) {
            ['dashboard', 'roadmap', 'drive'].forEach(v => {
                document.getElementById(`view-${v}`).style.opacity = '0';
                document.getElementById(`view-${v}`).style.pointerEvents = 'none';
                document.getElementById(`btn-${v}`).classList.remove('active');
            });
            const activeEl = document.getElementById(`view-${viewName}`);
            activeEl.style.opacity = '1';
            activeEl.style.pointerEvents = 'auto';
            activeEl.style.zIndex = '20';
            document.getElementById(`btn-${viewName}`).classList.add('active');
        }
        function toggleEditMode(isEditing) {
            document.getElementById('header-view').classList.toggle('hidden', isEditing);
            document.getElementById('header-edit').classList.toggle('hidden', !isEditing);
            document.getElementById('content-view').classList.toggle('hidden', isEditing);
            document.getElementById('content-edit').classList.toggle('hidden', !isEditing);
            document.getElementById('btn-edit').classList.toggle('hidden', isEditing);
            document.getElementById('btn-save').classList.toggle('hidden', !isEditing);
            document.getElementById('btn-cancel').classList.toggle('hidden', !isEditing);
        }
        function closeModal() {
            const modal = document.getElementById('programModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('#modalContent').classList.remove('scale-100');
            modal.querySelector('#modalContent').classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); document.body.classList.remove('modal-active'); }, 300);
        }
        function filterProgram(type) {
            if(type === 'all') renderRoadmap(programKerja);
            else renderRoadmap(programKerja.filter(p => p.pillar === type || (type==='Kesehatan' && p.pillar==='Sosial')));
        }
        function renderDriveSidebar() {
            const container = document.getElementById('driveSidebar');
            container.innerHTML = driveFolders.map(f => `<div onclick="loadDriveFolder('${f.id}', '${f.name}')" class="folder-item cursor-pointer p-3 border-l-4 border-transparent hover:bg-slate-50 transition flex items-center gap-3 group"><i class="fas ${f.icon} text-slate-400 group-hover:text-cpi-600 text-lg w-6 text-center"></i><div class="overflow-hidden"><h3 class="text-xs font-bold text-slate-700 truncate">${f.name}</h3><p class="text-[10px] text-slate-400 truncate">${f.label}</p></div></div>`).join('');
            if(driveFolders.length > 0) loadDriveFolder(driveFolders[0].id, driveFolders[0].name);
        }
        function loadDriveFolder(id, name) {
            document.getElementById('driveFolderTitle').innerText = name;
            document.getElementById('driveExternalLink').href = `https://drive.google.com/drive/folders/${id}?usp=drive_link`;
            const frame = document.getElementById('driveFrame');
            const loader = document.getElementById('driveLoader');
            frame.classList.add('hidden'); loader.classList.remove('hidden');
            frame.src = `https://drive.google.com/embeddedfolderview?id=${id}#list`;
            frame.onload = () => { loader.classList.add('hidden'); frame.classList.remove('hidden'); };
        }
        window.onclick = function(e) { if(e.target == document.getElementById('programModal')) closeModal(); }
    </script>
</body>
</html>
