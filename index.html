<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CPI Command Center 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PDF Generation Libraries (New) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { cpi: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' }, gold: { 500: '#d97706', 600: '#b45309' } }
                }
            }
        }
    </script>

    <style>
        .drive-frame { width: 100%; height: 100%; min-height: 500px; border: none; background-color: #f8fafc; }
        .nav-btn.active { background-color: #0369a1; color: white; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .nav-btn:not(.active) { background-color: transparent; color: #64748b; }
        .mobile-nav-btn.active { color: #0369a1; }
        .mobile-nav-btn.active span { font-weight: 700; }
        .mobile-nav-btn:not(.active) { color: #94a3b8; }
        .folder-item.active { background-color: #e0f2fe; color: #0369a1; border-right: 3px solid #0369a1; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        .kanban-col { min-height: 200px; background-color: #f8fafc; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
        .kanban-card { transition: all 0.2s; cursor: pointer; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        #cloud-loader { backdrop-filter: blur(4px); background-color: rgba(255,255,255,0.7); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .edit-input { width: 100%; border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 0.375rem; font-size: 0.875rem; }
        .edit-input:focus { outline: none; border-color: #0369a1; ring: 2px solid #e0f2fe; }

        /* TIMELINE & CALENDAR */
        .timeline-container { position: relative; padding: 20px 0; }
        .timeline-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #e2e8f0; transform: translateX(-50%); border-radius: 2px; }
        .timeline-item { position: relative; margin-bottom: 40px; width: 100%; display: flex; justify-content: center; align-items: center; }
        .timeline-content { width: 45%; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: relative; transition: all 0.3s ease; border: 1px solid #f1f5f9; cursor: pointer; }
        .timeline-content:hover { transform: scale(1.03); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #0ea5e9; }
        .timeline-dot { width: 40px; height: 40px; border-radius: 50%; background: #0369a1; position: absolute; left: 50%; transform: translateX(-50%); border: 4px solid #fff; box-shadow: 0 0 0 4px #e0f2fe; z-index: 10; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .timeline-item:nth-child(odd) .timeline-content { margin-right: auto; margin-left: 0; text-align: right; }
        .timeline-item:nth-child(even) .timeline-content { margin-left: auto; margin-right: 0; text-align: left; }
        .timeline-item:nth-child(odd) .timeline-content::after { content: ''; position: absolute; right: -10px; top: 15px; border-width: 10px 0 10px 10px; border-color: transparent transparent transparent white; }
        .timeline-item:nth-child(even) .timeline-content::after { content: ''; position: absolute; left: -10px; top: 15px; border-width: 10px 10px 10px 0; border-color: transparent white transparent transparent; }
        @media (max-width: 768px) { .timeline-line { left: 20px; } .timeline-item { justify-content: flex-start; padding-left: 50px; } .timeline-content { width: 100%; text-align: left !important; } .timeline-dot { left: 20px; } .timeline-item:nth-child(odd) .timeline-content::after { left: -10px; right: auto; border-width: 10px 10px 10px 0; border-color: transparent white transparent transparent; } }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; }
        .calendar-header { background-color: #f8fafc; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 0.7rem; padding: 0.5rem; text-align: center; }
        .calendar-day { background-color: white; min-height: 80px; padding: 4px; position: relative; transition: background 0.2s; }
        .calendar-day:hover { background-color: #f8fafc; }
        .day-number { font-size: 0.75rem; font-weight: 600; color: #475569; position: absolute; top: 4px; right: 6px; }
        .event-marker { font-size: 0.6rem; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; font-weight: 500; }
        .marker-plan { background-color: #dbeafe; color: #1e40af; border-left: 2px solid #3b82f6; }
        .marker-exec { background-color: #d1fae5; color: #065f46; border-left: 2px solid #10b981; font-weight: 700; }
        .marker-eval { background-color: #fee2e2; color: #991b1b; border-left: 2px solid #ef4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased h-screen flex flex-col overflow-hidden pb-16 md:pb-0">

    <!-- Loader -->
    <div id="cloud-loader" class="fixed inset-0 z-[70] flex flex-col items-center justify-center hidden">
        <div class="w-16 h-16 border-4 border-cpi-200 border-t-cpi-700 rounded-full animate-spin mb-4"></div>
        <h3 class="font-bold text-cpi-900 text-lg">Menyinkronkan...</h3>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-white border-b border-slate-200 z-40 h-16 flex-none shadow-sm">
        <div class="max-w-full px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between items-center h-full">
                <div class="flex items-center gap-3">
                    <div class="h-9 w-auto flex items-center justify-center">
                        <img src="https://i.ibb.co.com/KxWySDqp/logo-cpi.png" alt="Logo CPI" class="h-9 w-auto object-contain" onerror="this.src='https://ui-avatars.com/api/?name=CPI&background=0369a1&color=fff';">
                    </div>
                    <div class="leading-tight">
                        <h1 class="font-bold text-base md:text-lg text-slate-900 tracking-tight">CPI Foundation</h1>
                        <p class="text-[9px] md:text-[10px] font-bold tracking-widest text-gold-600 uppercase">System 2026</p>
                    </div>
                </div>
                <!-- Menu -->
                <div class="hidden md:flex bg-slate-100 p-1 rounded-lg gap-1">
                    <button onclick="switchView('dashboard')" id="btn-dashboard" class="nav-btn active px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2"><i class="fas fa-chart-pie"></i> Dashboard</button>
                    <button onclick="switchView('finance')" id="btn-finance" class="nav-btn px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2"><i class="fas fa-wallet"></i> Keuangan</button>
                    <button onclick="switchView('kanban')" id="btn-kanban" class="nav-btn px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2"><i class="fas fa-columns"></i> Kanban</button>
                    <button onclick="switchView('roadmap')" id="btn-roadmap" class="nav-btn px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2"><i class="fas fa-calendar-alt"></i> Kalender</button>
                    <button onclick="switchView('drive')" id="btn-drive" class="nav-btn px-4 py-2 text-xs font-bold rounded-md transition flex items-center gap-2"><i class="fab fa-google-drive"></i> Arsip</button>
                </div>
                <div class="flex items-center gap-3">
                    <div id="status-indicator" class="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded border border-yellow-200"><div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div><span class="text-[10px] font-bold text-yellow-700 hidden md:inline">Connecting...</span></div>
                    <button onclick="forceSync()" class="text-[10px] bg-cpi-100 text-cpi-700 px-2 py-1 rounded hover:bg-cpi-200 transition h-8 w-8 flex items-center justify-center rounded-full"><i class="fas fa-sync"></i></button>
                    <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden border border-slate-300"><img src="https://ui-avatars.com/api/?name=Admin+CPI&background=0c4a6e&color=fff" alt="Profile"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MOBILE NAV -->
    <div class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <button onclick="switchView('dashboard')" id="mob-dashboard" class="mobile-nav-btn active flex flex-col items-center justify-center w-full h-full"><i class="fas fa-chart-pie text-lg mb-1"></i><span class="text-[10px]">Dash</span></button>
        <button onclick="switchView('finance')" id="mob-finance" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full"><i class="fas fa-wallet text-lg mb-1"></i><span class="text-[10px]">Kas</span></button>
        <button onclick="switchView('kanban')" id="mob-kanban" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full"><i class="fas fa-columns text-lg mb-1"></i><span class="text-[10px]">Progres</span></button>
        <button onclick="switchView('roadmap')" id="mob-roadmap" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full"><i class="fas fa-calendar-alt text-lg mb-1"></i><span class="text-[10px]">Kalender</span></button>
        <button onclick="switchView('drive')" id="mob-drive" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full"><i class="fab fa-google-drive text-lg mb-1"></i><span class="text-[10px]">Arsip</span></button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 relative overflow-hidden bg-slate-50">

        <!-- VIEW 1: DASHBOARD -->
        <div id="view-dashboard" class="absolute inset-0 overflow-y-auto p-4 md:p-6 transition-opacity duration-300 z-20 bg-slate-50">
            <div class="max-w-5xl mx-auto space-y-8 pb-20">
                <div class="bg-cpi-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div><h2 class="text-2xl md:text-3xl font-bold mb-2">Pusat Komando 2026</h2><p class="text-cpi-100 text-sm max-w-lg">Pantau "Golden Moments" dan eksekusi program strategis yayasan secara real-time.</p></div>
                        <div class="flex gap-4 text-center">
                            <div class="bg-white/10 px-4 py-2 rounded-lg backdrop-blur"><span class="block text-2xl font-bold text-gold-500" id="dashTotal">0</span><span class="text-[10px] uppercase tracking-wider text-cpi-200">Program</span></div>
                            <div class="bg-white/10 px-4 py-2 rounded-lg backdrop-blur"><span class="block text-2xl font-bold text-emerald-400" id="dashDone">0</span><span class="text-[10px] uppercase tracking-wider text-cpi-200">Selesai</span></div>
                        </div>
                    </div>
                </div>
                <div><h3 class="font-bold text-slate-700 mb-6 flex items-center gap-2 text-lg"><i class="fas fa-route text-cpi-600"></i> Peta Jalan Strategis (Timeline)</h3><div class="timeline-container" id="creativeTimeline"><div class="timeline-line"></div></div></div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 mb-4 text-sm">Distribusi Pilar</h4><div class="h-48 relative"><canvas id="pillarChart"></canvas></div></div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><h4 class="font-bold text-slate-700 mb-4 text-sm">Status Eksekusi</h4><div class="h-48 relative"><canvas id="statusChart"></canvas></div></div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: KEUANGAN (UPDATED COA + PDF) -->
        <div id="view-finance" class="absolute inset-0 overflow-y-auto p-4 md:p-6 transition-opacity duration-300 z-10 opacity-0 pointer-events-none bg-slate-50">
            <div class="max-w-5xl mx-auto space-y-6 pb-20">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-2 gap-3">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2"><i class="fas fa-wallet text-cpi-600"></i> Buku Kas Umum</h2>
                        <p class="text-xs text-slate-500 mt-1">Pencatatan sesuai Kode Akun Yayasan.</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="downloadReportPDF()" class="px-4 py-2 text-xs font-bold bg-white text-rose-600 border border-rose-200 rounded-lg shadow-sm hover:bg-rose-50 transition"><i class="fas fa-file-pdf mr-1"></i> Unduh Laporan</button>
                        <button onclick="openFinanceModal()" class="px-4 py-2 text-xs font-bold bg-cpi-700 text-white rounded-lg shadow hover:bg-cpi-800 transition"><i class="fas fa-plus mr-1"></i> Catat Transaksi</button>
                    </div>
                </div>

                <!-- Finance Cards -->
                <div class="grid grid-cols-3 gap-3 md:gap-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Total Masuk</div>
                        <div class="text-lg md:text-2xl font-bold text-emerald-600" id="finIn">Rp 0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-rose-500">
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Total Keluar</div>
                        <div class="text-lg md:text-2xl font-bold text-rose-600" id="finOut">Rp 0</div>
                    </div>
                    <div class="bg-cpi-700 p-4 rounded-xl shadow-lg text-white">
                        <div class="text-[10px] text-cpi-200 font-bold uppercase">Saldo Akhir</div>
                        <div class="text-lg md:text-2xl font-bold" id="finBalance">Rp 0</div>
                    </div>
                </div>

                <!-- Finance Chart -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-700 text-sm">Grafik Arus Kas</h4>
                    </div>
                    <div class="h-64 relative"><canvas id="financeChart"></canvas></div>
                </div>

                <!-- Transaction List -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 font-bold text-xs text-slate-700 uppercase">Riwayat Transaksi (Jurnal)</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-50 text-slate-500">
                                <tr>
                                    <th class="p-3">Tanggal</th>
                                    <th class="p-3">No. Bukti</th>
                                    <th class="p-3">Uraian</th>
                                    <th class="p-3">Akun</th>
                                    <th class="p-3 text-right">Nominal</th>
                                    <th class="p-3 text-center">Status</th>
                                    <th class="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="financeTableBody" class="divide-y divide-slate-100">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 3: KANBAN -->
        <div id="view-kanban" class="absolute inset-0 overflow-y-auto p-4 transition-opacity duration-300 z-10 opacity-0 pointer-events-none bg-slate-50">
            <div class="max-w-7xl mx-auto h-full flex flex-col pb-20">
                <div class="mb-4">
                    <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2"><i class="fas fa-columns text-cpi-600"></i> Papan Kontrol</h2>
                    <p class="text-xs text-slate-500">Monitoring status pelaksanaan program dengan indikator visual.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- KOLOM 1: RENCANA -->
                    <div class="kanban-col flex flex-col">
                        <div class="p-3 border-b bg-slate-100 rounded-t-lg flex justify-between items-center">
                            <h3 class="font-bold text-slate-600 text-xs uppercase"><i class="far fa-circle mr-2"></i> Rencana</h3>
                            <span class="bg-slate-200 px-2 rounded-full text-[10px]" id="count-todo">0</span>
                        </div>
                        <div class="p-2 space-y-2" id="kanban-todo"></div>
                    </div>
                    
                    <!-- KOLOM 2: BERJALAN -->
                    <div class="kanban-col flex flex-col border-t-4 border-blue-500">
                        <div class="p-3 border-b bg-blue-50 rounded-t-lg flex justify-between items-center">
                            <h3 class="font-bold text-blue-700 text-xs uppercase"><i class="fas fa-spinner fa-spin mr-2"></i> Berjalan</h3>
                            <span class="bg-blue-200 px-2 rounded-full text-[10px]" id="count-doing">0</span>
                        </div>
                        <div class="p-2 space-y-2 bg-blue-50/30" id="kanban-doing"></div>
                    </div>
                    
                    <!-- KOLOM 3: SELESAI/ARSIP -->
                    <div class="kanban-col flex flex-col border-t-4 border-emerald-500">
                        <div class="p-3 border-b bg-emerald-50 rounded-t-lg flex justify-between items-center">
                            <h3 class="font-bold text-emerald-700 text-xs uppercase"><i class="fas fa-check-circle mr-2"></i> Selesai / Arsip</h3>
                            <span class="bg-emerald-200 px-2 rounded-full text-[10px]" id="count-done">0</span>
                        </div>
                        <div class="p-2 space-y-2 bg-emerald-50/30" id="kanban-done"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 4: ROADMAP -->
        <div id="view-roadmap" class="absolute inset-0 overflow-y-auto p-4 transition-opacity duration-300 z-10 opacity-0 pointer-events-none bg-slate-50">
            <div class="max-w-7xl mx-auto space-y-6 pb-20">
                <div class="flex flex-col gap-4 border-b border-slate-200 pb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-900 flex items-center gap-2"><i class="fas fa-calendar-alt text-cpi-600"></i> Kalender Kegiatan</h2>
                        <button onclick="openGuide()" class="px-3 py-1.5 text-[10px] font-bold rounded-full bg-indigo-100 text-indigo-700 border border-indigo-200 hover:bg-indigo-200 transition shadow-sm animate-pulse"><i class="fas fa-book-open mr-1"></i> Panduan</button>
                    </div>
                    <div class="flex justify-between items-center bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-100 rounded-full text-slate-600"><i class="fas fa-chevron-left"></i></button>
                        <h3 class="font-bold text-lg text-cpi-700 uppercase tracking-wide" id="currentMonthYear">Januari 2026</h3>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-slate-100 rounded-full text-slate-600"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="grid grid-cols-7 border-b border-slate-200 bg-slate-50"><div class="calendar-header text-red-500">Min</div><div class="calendar-header">Sen</div><div class="calendar-header">Sel</div><div class="calendar-header">Rab</div><div class="calendar-header">Kam</div><div class="calendar-header">Jum</div><div class="calendar-header">Sab</div></div>
                    <div class="calendar-grid" id="calendarDays"></div>
                </div>
                <div class="flex flex-wrap gap-4 text-xs text-slate-600 justify-center bg-white p-3 rounded-lg border border-slate-200">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-100 border-l-2 border-blue-500"></span> Perencanaan (H-14)</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-100 border-l-2 border-emerald-500"></span> Pelaksanaan (H)</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-100 border-l-2 border-red-500"></span> Evaluasi (H+7)</div>
                </div>
            </div>
        </div>

        <!-- VIEW 5: DRIVE -->
        <div id="view-drive" class="absolute inset-0 flex flex-col md:flex-row transition-opacity duration-300 z-10 opacity-0 pointer-events-none bg-slate-50 pb-16 md:pb-0">
            <aside class="w-full md:w-80 bg-white border-b md:border-r border-slate-200 flex flex-col shadow-lg z-20 flex-none h-1/3 md:h-full">
                <div class="p-3 border-b border-slate-100 bg-slate-50"><h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider">Pilih Folder</h2></div>
                <div class="flex-1 overflow-y-auto py-2 space-y-1" id="driveSidebar"></div>
            </aside>
            <main class="flex-1 flex flex-col bg-slate-100 h-2/3 md:h-full relative">
                <div class="h-10 bg-white border-b border-slate-200 flex justify-between items-center px-4 flex-none">
                    <div class="flex items-center gap-2 overflow-hidden"><i class="fas fa-folder-open text-yellow-500"></i><span id="driveFolderTitle" class="font-bold text-xs text-slate-700 truncate">Memuat...</span></div>
                    <a id="driveExternalLink" href="#" target="_blank" class="text-[10px] font-bold text-cpi-600 hover:underline flex-none">Buka Tab Baru <i class="fas fa-external-link-alt ml-1"></i></a>
                </div>
                <div class="flex-1 relative bg-slate-50">
                    <div id="driveLoader" class="absolute inset-0 flex items-center justify-center z-0"><div class="text-center animate-pulse"><i class="fab fa-google-drive text-3xl text-slate-300"></i></div></div>
                    <iframe id="driveFrame" class="drive-frame relative z-10" src=""></iframe>
                </div>
            </main>
        </div>

        <!-- GUIDE MODAL -->
        <div id="guideModal" class="fixed inset-0 z-[60] hidden opacity-0 pointer-events-none flex items-center justify-center bg-black/50 backdrop-blur-sm modal p-2 md:p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col transform transition-all scale-95 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 flex-none">
                    <h3 class="font-bold text-sm md:text-lg text-slate-800 flex items-center"><i class="fas fa-atlas text-cpi-600 mr-2"></i> Panduan Strategis 2026</h3>
                    <button onclick="closeGuide()" class="text-slate-400 hover:text-red-500 p-2"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="p-5 overflow-y-auto prose prose-sm prose-slate max-w-none bg-white">
                    <h2 class="text-center">Laporan Strategis 2026</h2>
                    <p>Ringkasan: Tahun 2026 adalah International Year of Volunteers. Fokus 3 Pilar: Pendidikan, Kesehatan, Lingkungan.</p>
                    <p>(Konten lengkap sesuai dokumen word sebelumnya...)</p>
                </div>
            </div>
        </div>

        <!-- PROGRAM EDIT MODAL (SIMPLIFIED & UPDATED) -->
        <div id="programModal" class="fixed inset-0 z-[60] hidden opacity-0 pointer-events-none flex items-center justify-center bg-black/50 backdrop-blur-sm modal p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg h-auto max-h-[90vh] flex flex-col transform transition-all scale-95 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-100 flex justify-between items-center bg-slate-50 flex-none">
                    <div id="header-view" class="w-full"><h3 class="font-bold text-base text-slate-800 leading-tight" id="modalTitle">Judul</h3></div>
                    <div id="header-edit" class="w-full hidden"><input type="text" id="editTitle" class="edit-input font-bold text-base" placeholder="Judul"></div>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 ml-3"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="p-4 overflow-y-auto space-y-4 flex-1">
                    <div id="content-view" class="space-y-4">
                         <!-- View Content populated by JS -->
                    </div>
                    <div id="content-edit" class="space-y-3 hidden">
                        <!-- STATUS DROPDOWN BARU -->
                        <div class="bg-indigo-50 p-2 rounded border border-indigo-100">
                            <label class="text-[10px] font-bold text-indigo-700 uppercase block mb-1">Status Pelaksanaan</label>
                            <select id="editStatus" class="w-full border rounded p-1 text-xs font-bold text-slate-700">
                                <option value="waiting">âšª Menunggu (Rencana)</option>
                                <option value="progress">ðŸ”µ On Progress (Berjalan)</option>
                                <option value="completed">ðŸŸ¢ Terlaksana (Selesai)</option>
                                <option value="pending">ðŸŸ  Tertunda (Arsip)</option>
                                <option value="canceled">ðŸ”´ Gagal/Batal (Arsip)</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-slate-500 uppercase">Tanggal</label><input type="date" id="editDate" class="edit-input text-xs" onchange="autoUpdateMonth()"></div><div><label class="text-[10px] font-bold text-slate-500 uppercase">Bulan (Auto)</label><input type="text" id="editMonth" class="edit-input text-xs bg-gray-100" readonly></div></div>
                        <div><label class="text-[10px] font-bold text-slate-500 uppercase">Deskripsi</label><textarea id="editDesc" rows="2" class="edit-input text-xs"></textarea></div>
                        <div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-slate-500 uppercase">KPI</label><input type="text" id="editKPI" class="edit-input text-xs"></div><div><label class="text-[10px] font-bold text-slate-500 uppercase">RAB</label><input type="text" id="editRAB" class="edit-input text-xs font-mono"></div><div><label class="text-[10px] font-bold text-slate-500 uppercase">Loc</label><input type="text" id="editLoc" class="edit-input text-xs"></div></div>
                        <div><label class="text-[10px] font-bold text-slate-500 uppercase">Tahapan</label><textarea id="editSteps" rows="3" class="edit-input text-xs"></textarea></div>
                        <!-- Validation Fields REMOVED -->
                    </div>
                </div>
                <div class="px-4 py-3 border-t border-slate-100 bg-slate-50 flex justify-between items-center flex-none">
                    <div class="flex gap-2 w-full justify-end">
                        <button id="btn-cancel" onclick="toggleEditMode(false)" class="px-3 py-1.5 text-xs font-bold text-slate-600 hover:bg-slate-200 rounded hidden">Batal</button>
                        <button id="btn-delete" onclick="deleteProgram()" class="px-3 py-1.5 text-xs font-bold bg-red-50 text-red-600 border border-red-200 rounded hidden hover:bg-red-100"><i class="fas fa-trash"></i></button>
                        <button id="btn-edit" onclick="toggleEditMode(true)" class="px-3 py-1.5 text-xs font-bold bg-white border text-slate-700 rounded shadow-sm"><i class="fas fa-edit mr-1"></i> Edit</button>
                        <button id="btn-save" onclick="saveChanges()" class="px-3 py-1.5 text-xs font-bold bg-green-600 text-white rounded shadow hidden"><i class="fas fa-save mr-1"></i> Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FINANCE MODAL (SOP COMPLIANT) -->
        <div id="financeModal" class="fixed inset-0 z-[60] hidden opacity-0 pointer-events-none flex items-center justify-center bg-black/50 backdrop-blur-sm modal p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col transform transition-all scale-95 max-h-[90vh]">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                    <h3 class="font-bold text-base text-slate-800"><i class="fas fa-edit mr-2 text-cpi-600"></i> Input Transaksi (SOP)</h3>
                    <button onclick="closeFinanceModal()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times text-lg"></i></button>
                </div>
                <div class="p-6 overflow-y-auto space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold uppercase text-slate-500 block mb-1">Tanggal</label><input type="date" id="finDate" class="edit-input text-xs"></div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-500 block mb-1">No. Bukti</label><input type="text" id="finRef" class="edit-input text-xs font-mono" placeholder="BKK-001"></div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold uppercase text-slate-500 block mb-1">Akun (COA)</label>
                        <select id="finAccount" class="w-full border border-slate-300 rounded p-2 text-xs bg-white font-medium" onchange="autoSetFlowType()">
                            <optgroup label="100-199 ASET (HARTA)">
                                <option value="101">101 - Kas Kecil (Petty Cash)</option>
                                <option value="102">102 - Bank - Operasional</option>
                                <option value="103">103 - Bank - Khusus Donasi</option>
                            </optgroup>
                            <optgroup label="400-499 PENERIMAAN (IN)">
                                <option value="401">401 - Donasi Tidak Terikat</option>
                                <option value="402">402 - Donasi Terikat (CSR)</option>
                                <option value="403">403 - Hasil Usaha</option>
                            </optgroup>
                            <optgroup label="500-599 PENGELUARAN PROGRAM (OUT)">
                                <option value="501">501 - Beban Program Pendidikan</option>
                                <option value="502">502 - Beban Program Kesehatan</option>
                                <option value="503">503 - Beban Program Lingkungan</option>
                            </optgroup>
                            <optgroup label="600-699 PENGELUARAN OPERASIONAL (OUT)">
                                <option value="601">601 - Gaji & Honorarium</option>
                                <option value="602">602 - Transport & Akomodasi</option>
                                <option value="603">603 - Alat Tulis Kantor (ATK)</option>
                                <option value="604">604 - Konsumsi Rapat</option>
                            </optgroup>
                        </select>
                    </div>
                    <div><label class="text-[10px] font-bold uppercase text-slate-500 block mb-1">Uraian</label><textarea id="finDesc" rows="2" class="edit-input text-xs"></textarea></div>
                    <div class="grid grid-cols-2 gap-4 bg-slate-50 p-3 rounded border border-slate-200">
                        <div>
                            <label class="text-[10px] font-bold uppercase text-slate-500 block mb-1">Tipe</label>
                            <div class="flex gap-2">
                                <label class="flex items-center gap-1 text-xs"><input type="radio" name="finType" value="out" id="finTypeOut"> Keluar</label>
                                <label class="flex items-center gap-1 text-xs"><input type="radio" name="finType" value="in" id="finTypeIn"> Masuk</label>
                            </div>
                        </div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-500 block mb-1">Rp</label><input type="number" id="finAmount" class="edit-input text-sm font-bold text-rose-600 font-mono" placeholder="0"></div>
                    </div>
                    <div class="flex items-center gap-2 mt-2"><input type="checkbox" id="finApproval" class="rounded text-cpi-600"><label for="finApproval" class="text-[10px] text-slate-600">Transaksi valid & ada bukti.</label></div>
                </div>
                <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-2 rounded-b-xl">
                    <button onclick="closeFinanceModal()" class="px-4 py-2 text-xs font-bold text-slate-600 hover:bg-slate-200 rounded-lg transition">Batal</button>
                    <button onclick="saveTransaction()" class="px-4 py-2 text-xs font-bold bg-cpi-700 text-white rounded-lg shadow hover:bg-cpi-800 transition"><i class="fas fa-save mr-1"></i> Simpan</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxt87Vpeg8rhvf0cRj22-N95qGAshGt5J3sqceEUkAnnQJUmnIBY-T2yarIH646zWCC/exec"; 
        const fallbackData = [{ id: 1, status: 'waiting', month: 'Januari', date: '17', fullDate: '2026-01-17', title: 'Webinar Safety', pillar: 'Kesehatan', color: 'rose', desc: 'Demo K3', kpi: '50 Org', rab: 'Rp 5jt', loc: 'Online', steps: ['Siap Alat'] }];
        
        // NEW STATUS CONFIG
        const statusConfig = {
            'waiting': { label: 'Menunggu', class: 'bg-slate-100 text-slate-600 border-slate-200', icon: 'fa-pause-circle' },
            'progress': { label: 'On Progress', class: 'bg-blue-100 text-blue-700 border-blue-200', icon: 'fa-spinner fa-spin' },
            'completed': { label: 'Terlaksana', class: 'bg-emerald-100 text-emerald-700 border-emerald-200', icon: 'fa-check-circle' },
            'pending': { label: 'Tertunda', class: 'bg-orange-100 text-orange-700 border-orange-200', icon: 'fa-clock' },
            'canceled': { label: 'Gagal/Batal', class: 'bg-red-100 text-red-700 border-red-200', icon: 'fa-times-circle' },
            // Backward comp
            'todo': { label: 'Menunggu', class: 'bg-slate-100 text-slate-600 border-slate-200', icon: 'fa-pause-circle' },
            'doing': { label: 'On Progress', class: 'bg-blue-100 text-blue-700 border-blue-200', icon: 'fa-spinner fa-spin' },
            'done': { label: 'Terlaksana', class: 'bg-emerald-100 text-emerald-700 border-emerald-200', icon: 'fa-check-circle' }
        };

        let programKerja = []; let financeData = []; 
        let currentEditId = null; let currentMonth = 0; // Jan 2026
        const monthsName = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

        const driveStructure = [
            { id: 'root_00', name: '00. Legalitas', icon: 'fa-balance-scale', children: [{ id: '1dCTcYgSlOgWD5fW6dY8Wfxd1IQE-J44C', name: '00.01 Pendirian' }, { id: '1mvhu5ix98mn-f-kovtpEhSV9UEVOG4dz', name: '00.02 Perizinan' }] },
            { id: 'root_01', name: '01. Tata Kelola', icon: 'fa-sitemap', children: [{ id: '1OQNeISfkxxsurR8FWwScWNJI_HoLQEJf', name: '01.01 SK Pengurus' }, { id: '12P_8zrqq8AFPPZ5DS9QjPu2-_dIzxzsE', name: '01.02 Notulensi' }, { id: '1Z_XybabgHgjzel67I0PJZx3r5U-O2SJm', name: '01.03 SOP' }, { id: '1WAcMV8DVo-0jGoIjm2LyuhEQ2kmfOYx6', name: '01.04 AD/ART' }] },
            { id: 'root_02', name: '02. Program', icon: 'fa-briefcase', children: [{ id: '13qk0jrORF0IAhsSL0nH2ulTpWqr4CFi6', name: '02.01 Lingkungan' }, { id: '1aFRPAnGsafW4thaiajLAfYy1EFowwtuu', name: '02.02 Pendidikan' }, { id: '1-jZRcI5VtrViNliI_79ex-2CtX4qqJjl', name: '02.03 Kesehatan' }] },
            { id: 'root_03', name: '03. Keuangan', icon: 'fa-chart-line', children: [{ id: '1LudtpQOs9_ZuzMFBmzdG1drvoDTq8Zx-', name: '03.01 Donasi Internal' }, { id: '1gEZFWhpcggFYz8AWM5SbvAUOWm_08G6J', name: '03.02 CSR' }, { id: '1Jk27UsT8o4Ciq2rsZjIeq6k0IkUmexWX', name: '03.03 Unit Usaha' }, { id: '1xypdtuK9Xf8Wuq5lRPG3lzPohe53d6NX', name: '03.04 Audit' }] },
            { id: 'root_04', name: '04. Admin', icon: 'fa-user-tie', children: [{ id: '1kkcNmW4LkCI5G6Pk4kQWWE5U7Wc6LYJS', name: '04.01 Masuk' }, { id: '1RSxeB8o-9cMi8n5cAmUboE1FVo4Rm47L', name: '04.02 Keluar' }, { id: '1tPUy7ANiuLyvR8hGPUw63JBJS9EGizYF', name: '04.03 Relawan' }] },
            { id: 'root_05', name: '05. Media', icon: 'fa-bullhorn', children: [{ id: '1itUpV-0J3fvAEmBG47NHaa6LHS8kikOS', name: '05.01 Visual' }, { id: '1gX4UXrPT5nQgzkkOQosMoQSC0igiHNNJ', name: '05.02 Dok Kegiatan' }] }
        ];

        window.addEventListener('DOMContentLoaded', () => { 
            fetchData(); 
            const finLocal = localStorage.getItem('cpi_finance_local');
            if(finLocal) financeData = JSON.parse(finLocal);
            renderDriveSidebar(); 
            renderCalendar();
            renderFinance();
        });

        async function fetchData() {
            showLoader(true); setStatus('Connecting...', 'yellow');
            try {
                const res = await fetch(SCRIPT_URL); const data = await res.json();
                programKerja = (data && data.length) ? data.map(p => ({...p, status: p.status || 'waiting'})) : fallbackData;
                setStatus('Online', 'green');
            } catch (e) {
                const local = localStorage.getItem('cpi_cloud_backup');
                programKerja = local ? JSON.parse(local) : fallbackData;
                setStatus('Offline', 'red');
            } finally { refreshUI(); showLoader(false); }
        }

        async function saveDataToCloud() {
            showLoader(true); setStatus('Syncing...', 'yellow');
            try {
                localStorage.setItem('cpi_cloud_backup', JSON.stringify(programKerja));
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(programKerja) });
                setStatus('Online', 'green'); refreshUI();
            } catch (e) { setStatus('Sync Error', 'red'); } finally { showLoader(false); }
        }
        
        function forceSync() { if(confirm("Sync data?")) saveDataToCloud(); }
        function refreshUI() { updateDashboard(); renderCalendar(); renderKanban(); renderTimeline(); renderFinance(); }
        function showLoader(show) { document.getElementById('cloud-loader').className = show ? 'fixed inset-0 z-[70] flex flex-col items-center justify-center' : 'hidden'; }
        function setStatus(text, color) { document.getElementById('status-indicator').innerHTML = `<div class="w-2 h-2 rounded-full bg-${color}-500 animate-pulse"></div><span class="text-[10px] font-bold text-${color}-700 hidden md:inline">${text}</span>`; }

        function updateDashboard() {
            const total = programKerja.length; let done = 0;
            programKerja.forEach(p => { if(p.status === 'completed' || p.status === 'done') done++; });
            document.getElementById('dashTotal').innerText = total; document.getElementById('dashDone').innerText = done;
            
            const pCounts = {'Pendidikan':0,'Kesehatan':0,'Lingkungan':0,'Internal':0};
            const sCounts = {'completed':0,'progress':0,'waiting':0};
            programKerja.forEach(p => {
                let k = p.pillar; if(k==='Sosial') k='Kesehatan'; if(pCounts[k]!==undefined) pCounts[k]++;
                // Map old status to new simplified dashboard stats
                let st = p.status; 
                if(st==='todo') st='waiting'; if(st==='doing') st='progress'; if(st==='done') st='completed';
                if(['pending','canceled'].includes(st)) st='completed'; // Group finished items
                if(sCounts[st]!==undefined) sCounts[st]++;
            });

            const ctx1 = document.getElementById('pillarChart').getContext('2d');
            if(window.pillarChart instanceof Chart) window.pillarChart.destroy();
            window.pillarChart = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(pCounts), datasets: [{ data: Object.values(pCounts), backgroundColor: ['#3b82f6','#f43f5e','#10b981','#64748b'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins:{legend:{position:'right',labels:{font:{size:10},boxWidth:10}}} } });

            const ctx2 = document.getElementById('statusChart').getContext('2d');
            if(window.statusChart instanceof Chart) window.statusChart.destroy();
            window.statusChart = new Chart(ctx2, { type: 'pie', data: { labels: ['Selesai','Berjalan','Rencana'], datasets: [{ data: [sCounts.completed, sCounts.progress, sCounts.waiting], backgroundColor: ['#10b981','#a855f7','#cbd5e1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins:{legend:{position:'right',labels:{font:{size:10},boxWidth:10}}} } });
        }

        // --- FINANCE FUNCTIONS ---
        function openFinanceModal() { const m = document.getElementById('financeModal'); m.classList.remove('hidden','pointer-events-none','opacity-0'); m.querySelector('div').classList.add('scale-100'); }
        function closeFinanceModal() { const m = document.getElementById('financeModal'); m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        function saveTransaction() {
            const date = document.getElementById('finDate').value;
            const ref = document.getElementById('finRef').value;
            const type = document.querySelector('input[name="finType"]:checked').value;
            const amt = parseInt(document.getElementById('finAmount').value)||0;
            const desc = document.getElementById('finDesc').value;
            const cat = document.getElementById('finAccount').value;
            const ok = document.getElementById('finApproval').checked;
            if(!date || amt<=0) return alert("Lengkapi data!");
            financeData.push({ id: Date.now(), date, ref, type, amount: amt, desc, category: cat, status: ok?'verified':'pending' });
            localStorage.setItem('cpi_finance_local', JSON.stringify(financeData));
            renderFinance(); closeFinanceModal();
        }
        function renderFinance() {
            let totalIn=0, totalOut=0; const tbody = document.getElementById('financeTableBody'); tbody.innerHTML = '';
            financeData.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(t => {
                if(t.type==='in') totalIn+=t.amount; else totalOut+=t.amount;
                const c = t.type==='in'?'text-emerald-600':'text-rose-600';
                tbody.innerHTML += `<tr><td class="p-3 border-b">${t.date}</td><td class="p-3 border-b font-mono">${t.ref||'-'}</td><td class="p-3 border-b font-bold text-slate-700">${t.desc}</td><td class="p-3 border-b text-slate-500">${t.category}</td><td class="p-3 border-b text-right font-mono ${c}">${t.type==='in'?'+':'-'} ${t.amount.toLocaleString()}</td><td class="p-3 border-b text-center"><span class="px-2 py-0.5 rounded text-[10px] uppercase ${t.status==='verified'?'bg-emerald-100 text-emerald-700':'bg-yellow-100 text-yellow-700'}">${t.status}</span></td><td class="p-3 border-b text-center"><button onclick="deleteTrans(${t.id})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr>`;
            });
            document.getElementById('finIn').innerText = `Rp ${totalIn.toLocaleString()}`; document.getElementById('finOut').innerText = `Rp ${totalOut.toLocaleString()}`; document.getElementById('finBalance').innerText = `Rp ${(totalIn-totalOut).toLocaleString()}`;
            const ctx = document.getElementById('financeChart').getContext('2d'); if(window.financeChart instanceof Chart) window.financeChart.destroy();
            let bal=0; const trend = financeData.slice().reverse().map(d => { bal += (d.type==='in'?d.amount:-d.amount); return bal; });
            window.financeChart = new Chart(ctx, { type: 'line', data: { labels: financeData.slice().reverse().map(d=>d.date), datasets: [{ label: 'Saldo', data: trend, borderColor: '#0369a1', tension: 0.4, fill: true, backgroundColor: 'rgba(3, 105, 161, 0.1)' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
        }
        function deleteTrans(id) { if(confirm('Hapus transaksi?')) { financeData = financeData.filter(t=>t.id!==id); localStorage.setItem('cpi_finance_local', JSON.stringify(financeData)); renderFinance(); } }
        
        // --- PDF REPORT GENERATION (CASHFLOW FORMAT) ---
        function downloadReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.setTextColor(3, 105, 161); // Brand Color
            doc.text("LAPORAN ARUS KAS YAYASAN CPI", 105, 20, null, "center");
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("Periode: s.d. " + new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }), 105, 27, null, "center");
            doc.line(20, 32, 190, 32);

            // Grouping Logic
            let totalIn = 0;
            let totalOut = 0;
            
            const incomeCats = {
                '401': { name: 'Donasi Tidak Terikat', total: 0 },
                '402': { name: 'Donasi Terikat (CSR)', total: 0 },
                '403': { name: 'Hasil Usaha', total: 0 }
            };
            
            const expenseCats = {
                '501': { name: 'Beban Program Pendidikan', total: 0 },
                '502': { name: 'Beban Program Kesehatan', total: 0 },
                '503': { name: 'Beban Program Lingkungan', total: 0 },
                '601': { name: 'Gaji & Honorarium', total: 0 },
                '602': { name: 'Transport & Akomodasi', total: 0 },
                '603': { name: 'Alat Tulis Kantor', total: 0 },
                '604': { name: 'Konsumsi Rapat', total: 0 }
            };

            // Process Data
            financeData.forEach(t => {
                if (t.type === 'in') {
                    totalIn += t.amount;
                    if (incomeCats[t.category]) incomeCats[t.category].total += t.amount;
                } else {
                    totalOut += t.amount;
                    if (expenseCats[t.category]) expenseCats[t.category].total += t.amount;
                }
            });

            // Table Data Construction
            let bodyData = [];
            
            // Section: PEMASUKAN
            bodyData.push([{ content: 'ARUS KAS MASUK (PENERIMAAN)', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [240, 253, 250], textColor: [6, 95, 70] } }]);
            Object.values(incomeCats).forEach(c => {
                if (c.total > 0) bodyData.push([c.name, 'Rp ' + c.total.toLocaleString('id-ID')]);
            });
            bodyData.push([{ content: 'Total Penerimaan', styles: { fontStyle: 'bold' }}, { content: 'Rp ' + totalIn.toLocaleString('id-ID'), styles: { fontStyle: 'bold', textColor: [6, 95, 70] } }]);
            
            // Section: PENGELUARAN
            bodyData.push([{ content: 'ARUS KAS KELUAR (PENGELUARAN)', colSpan: 2, styles: { fontStyle: 'bold', fillColor: [255, 241, 242], textColor: [153, 27, 27], valign: 'middle' } }]);
            Object.values(expenseCats).forEach(c => {
                if (c.total > 0) bodyData.push([c.name, 'Rp ' + c.total.toLocaleString('id-ID')]);
            });
            bodyData.push([{ content: 'Total Pengeluaran', styles: { fontStyle: 'bold' }}, { content: 'Rp ' + totalOut.toLocaleString('id-ID'), styles: { fontStyle: 'bold', textColor: [153, 27, 27] } }]);

            // Section: SUMMARY
            const surplus = totalIn - totalOut;
            const surplusColor = surplus >= 0 ? [6, 95, 70] : [153, 27, 27];
            bodyData.push([{ content: '', colSpan: 2, styles: { fillColor: [255, 255, 255] } }]); // Spacer
            bodyData.push([{ content: 'SURPLUS / (DEFISIT)', styles: { fontStyle: 'bold', fontSize: 11, fillColor: [241, 245, 249] }}, { content: 'Rp ' + surplus.toLocaleString('id-ID'), styles: { fontStyle: 'bold', fontSize: 11, textColor: surplusColor, fillColor: [241, 245, 249] } }]);

            // Generate Table
            doc.autoTable({
                startY: 40,
                head: [['Uraian', 'Nominal']],
                body: bodyData,
                theme: 'grid',
                headStyles: { fillColor: [3, 105, 161], textColor: 255, fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 120 },
                    1: { cellWidth: 'auto', halign: 'right' }
                },
                styles: { fontSize: 10, cellPadding: 4 }
            });

            // Footer
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text("Dicetak otomatis oleh CPI Command Center", 20, 280);
            doc.text("Halaman 1 dari 1", 190, 280, null, "right");
            
            // Signatures Area
            if (finalY < 250) {
                doc.text("Disetujui Oleh,", 140, finalY);
                doc.text("Dibuat Oleh,", 30, finalY);
                doc.line(140, finalY + 25, 180, finalY + 25);
                doc.line(30, finalY + 25, 70, finalY + 25);
                doc.text("( Ketua Yayasan )", 140, finalY + 30);
                doc.text("( Bendahara )", 30, finalY + 30);
            }

            doc.save('Laporan_Keuangan_CPI_' + new Date().toISOString().split('T')[0] + '.pdf');
        }

        function autoSetFlowType() {
            const acc = document.getElementById('finAccount').value;
            if (acc >= 400 && acc < 500) { document.getElementById('finTypeIn').checked = true; } 
            else if (acc >= 500) { document.getElementById('finTypeOut').checked = true; }
        }

        // --- CALENDAR & TIMELINE ---
        function changeMonth(delta) { currentMonth += delta; if(currentMonth < 0) currentMonth = 0; if(currentMonth > 11) currentMonth = 11; renderCalendar(); }
        function renderCalendar() {
            const mName = monthsName[currentMonth]; const year = 2026;
            document.getElementById('currentMonthYear').innerText = `${mName} ${year}`;
            const firstDay = new Date(year, currentMonth, 1).getDay(); const daysInMonth = new Date(year, currentMonth + 1, 0).getDate();
            const container = document.getElementById('calendarDays'); container.innerHTML = '';
            for(let i=0; i<firstDay; i++) container.innerHTML += `<div class="calendar-day bg-slate-50/50"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                let html = `<div class="calendar-day"><span class="text-xs font-bold text-slate-400 absolute top-1 right-2">${d}</span><div class="mt-4 space-y-1">`;
                programKerja.forEach(p => {
                    let pDate = null;
                    if(p.fullDate) { const dobj = new Date(p.fullDate); if(dobj.getMonth()===currentMonth && dobj.getFullYear()===year) pDate = dobj.getDate(); }
                    else if (p.date && p.month === mName) { pDate = parseInt(p.date); }
                    if(pDate) {
                        if((pDate-14)===d) html += `<div class="event-marker marker-plan" onclick="openProgramDetail(${p.id})">PLAN: ${p.title}</div>`;
                        if(pDate===d) html += `<div class="event-marker marker-exec" onclick="openProgramDetail(${p.id})">EVENT: ${p.title}</div>`;
                        if((pDate+7)===d) html += `<div class="event-marker marker-eval" onclick="openProgramDetail(${p.id})">EVAL: ${p.title}</div>`;
                    }
                });
                html += `</div></div>`; container.innerHTML += html;
            }
        }
        function renderTimeline() {
            const container = document.getElementById('creativeTimeline');
            const sortedData = [...programKerja].sort((a,b) => monthsName.indexOf(a.month) - monthsName.indexOf(b.month));
            container.innerHTML = '<div class="timeline-line"></div>' + sortedData.map((p) => {
                const c = {'Pendidikan':'blue','Kesehatan':'rose','Lingkungan':'emerald','Internal':'slate','Sosial':'rose'}[p.pillar] || 'slate';
                const i = {'Pendidikan':'fa-graduation-cap','Kesehatan':'fa-heartbeat','Lingkungan':'fa-leaf','Internal':'fa-users','Sosial':'fa-hand-holding-heart'}[p.pillar] || 'fa-star';
                return `<div class="timeline-item group" onclick="openProgramDetail(${p.id})"><div class="timeline-dot bg-${c}-600"><i class="fas ${i}"></i></div><div class="timeline-content border-l-4 border-l-${c}-500"><div class="flex justify-between mb-1"><span class="text-[10px] font-bold text-${c}-600 uppercase tracking-widest">${p.month}</span><span class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">${p.date}</span></div><h4 class="font-bold text-sm text-slate-800 leading-tight mb-1 group-hover:text-${c}-600 transition">${p.title}</h4><p class="text-xs text-slate-500 line-clamp-2">${p.desc}</p></div></div>`;
            }).join('');
        }

        // --- KANBAN (UPDATED LOGIC) ---
        function renderKanban() {
            const cols = { 
                todo: document.getElementById('kanban-todo'), 
                doing: document.getElementById('kanban-doing'), 
                done: document.getElementById('kanban-done') 
            };
            Object.values(cols).forEach(c => c.innerHTML = '');
            const counts = { todo:0, doing:0, done:0 };
            
            programKerja.forEach(p => {
                const st = p.status || 'waiting';
                let targetCol = 'todo';
                
                // Logic Mapping
                if (st === 'waiting' || st === 'todo') targetCol = 'todo';
                else if (st === 'progress' || st === 'doing') targetCol = 'doing';
                else targetCol = 'done'; // completed, pending, canceled
                
                counts[targetCol]++;
                
                // Visual Config
                const c = {'Pendidikan':'blue','Kesehatan':'rose','Lingkungan':'emerald','Internal':'slate','Sosial':'rose'}[p.pillar] || 'slate';
                const sConf = statusConfig[st] || statusConfig['waiting'];
                
                const card = document.createElement('div'); 
                card.className = `kanban-card bg-white p-3 rounded shadow-sm border-l-4 border-${c}-500 mb-2`;
                
                // CARD HTML (SIMPLIFIED - NO CHECKS)
                card.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <span class="text-[9px] uppercase font-bold text-${c}-600 bg-${c}-50 px-1 py-0.5 rounded">${p.pillar}</span>
                        <div class="text-slate-400 text-xs hover:text-cpi-600"><i class="fas fa-edit"></i></div>
                    </div>
                    <h4 class="font-bold text-xs text-slate-800 mb-2 leading-tight">${p.title}</h4>
                    <div class="border-t border-slate-100 pt-2 flex items-center justify-between">
                        <span class="flex items-center gap-1 px-2 py-0.5 rounded text-[9px] font-bold uppercase border ${sConf.class}">
                            <i class="fas ${sConf.icon}"></i> ${sConf.label}
                        </span>
                    </div>
                `;
                
                card.onclick = () => openProgramDetail(p.id); 
                cols[targetCol].appendChild(card);
            });
            
            document.getElementById('count-todo').innerText = counts.todo; 
            document.getElementById('count-doing').innerText = counts.doing; 
            document.getElementById('count-done').innerText = counts.done;
        }

        // --- MODALS & EDITS ---
        function openProgramDetail(id) {
            currentEditId = id; const p = programKerja.find(x => x.id === id); if(!p) return;
            const c = {'Pendidikan':'blue','Kesehatan':'rose','Lingkungan':'emerald','Internal':'slate','Sosial':'rose'}[p.pillar];
            document.getElementById('modalTitle').innerText = p.title; 
            
            // Build View Content
            const sConf = statusConfig[p.status || 'waiting'] || statusConfig['waiting'];
            const viewHtml = `
                <div class="flex items-center justify-between mb-2">
                    <span class="px-2 py-0.5 bg-${c}-100 text-${c}-700 rounded text-[10px] font-bold uppercase">${p.pillar}</span>
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${sConf.class}"><i class="fas ${sConf.icon} mr-1"></i>${sConf.label}</span>
                </div>
                <p class="text-sm text-slate-600" id="modalDesc">${p.desc}</p>
                <div class="grid grid-cols-3 gap-2 text-xs bg-slate-50 p-3 rounded border border-slate-100">
                    <div><span class="block text-[10px] text-slate-400 uppercase font-bold">KPI</span><span class="font-bold">${p.kpi}</span></div>
                    <div><span class="block text-[10px] text-slate-400 uppercase font-bold">RAB</span><span class="font-mono text-emerald-600">${p.rab}</span></div>
                    <div><span class="block text-[10px] text-slate-400 uppercase font-bold">Lokasi</span><span>${p.loc}</span></div>
                </div>
                <div>
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-1">Tahapan</h4>
                    <ul class="space-y-1" id="modalSteps">
                        ${(p.steps||[]).map((s,i) => `<li class="flex gap-2 items-start text-xs text-slate-600"><span class="flex-none w-4 h-4 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-[10px] font-bold border">${i+1}</span><span>${s}</span></li>`).join('')}
                    </ul>
                </div>
            `;
            document.getElementById('content-view').innerHTML = viewHtml;
            
            // Populate Edit Form
            document.getElementById('editTitle').value = p.title; 
            document.getElementById('editDesc').value = p.desc;
            document.getElementById('editKPI').value = p.kpi; 
            document.getElementById('editRAB').value = p.rab;
            document.getElementById('editLoc').value = p.loc; 
            document.getElementById('editSteps').value = (p.steps||[]).join('\n'); 
            document.getElementById('editStatus').value = p.status || 'waiting'; // Set dropdown
            
            let dVal = ''; if(p.fullDate) dVal = p.fullDate; 
            else if(p.date) { const d = parseInt(p.date); const m = monthsName.indexOf(p.month); if(!isNaN(d) && m > -1) dVal = `2026-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
            document.getElementById('editDate').value = dVal; document.getElementById('editMonth').value = p.month || '';

            toggleEditMode(false);
            const m = document.getElementById('programModal'); m.classList.remove('hidden','pointer-events-none','opacity-0'); m.querySelector('div').classList.add('scale-100'); document.body.classList.add('modal-active');
        }

        function autoUpdateMonth() { const d = document.getElementById('editDate').value; if(d) document.getElementById('editMonth').value = monthsName[new Date(d).getMonth()]; }
        function deleteProgram() { if(currentEditId !== null && confirm("Hapus permanen?")) { programKerja = programKerja.filter(p => p.id !== currentEditId); closeModal(); saveDataToCloud(); } }

        function saveChanges() {
            if(currentEditId===null) return; const idx = programKerja.findIndex(p=>p.id===currentEditId); if(idx!==-1){
                programKerja[idx].title = document.getElementById('editTitle').value; 
                programKerja[idx].desc = document.getElementById('editDesc').value;
                programKerja[idx].kpi = document.getElementById('editKPI').value; 
                programKerja[idx].rab = document.getElementById('editRAB').value;
                programKerja[idx].loc = document.getElementById('editLoc').value; 
                programKerja[idx].steps = document.getElementById('editSteps').value.split('\n').filter(s=>s.trim()!=='');
                programKerja[idx].status = document.getElementById('editStatus').value; // Save new status
                
                const dVal = document.getElementById('editDate').value;
                if(dVal) { programKerja[idx].fullDate = dVal; programKerja[idx].date = new Date(dVal).getDate().toString(); programKerja[idx].month = document.getElementById('editMonth').value; }
                
                openProgramDetail(currentEditId); saveDataToCloud();
            }
        }

        function switchView(v) {
            ['dashboard','kanban','roadmap','drive','finance'].forEach(x => {
                document.getElementById(`view-${x}`).style.opacity = '0'; document.getElementById(`view-${x}`).style.pointerEvents = 'none';
                const d = document.getElementById(`btn-${x}`); if(d) d.classList.remove('active');
                const m = document.getElementById(`mob-${x}`); if(m) m.classList.remove('active');
            });
            const ae = document.getElementById(`view-${v}`); ae.style.opacity = '1'; ae.style.pointerEvents = 'auto'; ae.style.zIndex = '20';
            const ad = document.getElementById(`btn-${v}`); if(ad) ad.classList.add('active');
            const am = document.getElementById(`mob-${v}`); if(am) am.classList.add('active');
            if(v==='roadmap') renderCalendar();
        }

        function toggleEditMode(e) {
            document.getElementById('header-view').classList.toggle('hidden', e); document.getElementById('header-edit').classList.toggle('hidden', !e);
            document.getElementById('content-view').classList.toggle('hidden', e); document.getElementById('content-edit').classList.toggle('hidden', !e);
            document.getElementById('btn-edit').classList.toggle('hidden', e); document.getElementById('btn-save').classList.toggle('hidden', !e);
            document.getElementById('btn-cancel').classList.toggle('hidden', !e); document.getElementById('btn-delete').classList.toggle('hidden', !e);
        }
        function closeModal() { const m = document.getElementById('programModal'); m.classList.add('opacity-0','pointer-events-none'); setTimeout(()=>m.classList.add('hidden'),300); document.body.classList.remove('modal-active'); }
        function openGuide() { const m = document.getElementById('guideModal'); m.classList.remove('hidden','pointer-events-none','opacity-0'); m.querySelector('div').classList.add('scale-100'); }
        function closeGuide() { const m = document.getElementById('guideModal'); m.classList.add('opacity-0'); setTimeout(()=>m.classList.add('hidden'),300); }
        
        function renderDriveSidebar() { document.getElementById('driveSidebar').innerHTML = driveStructure.map(root => `<div class="mb-3"><div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1"><i class="fas ${root.icon}"></i> ${root.name}</div><div class="space-y-0.5">${root.children.map(c => `<div onclick="loadDriveFolder('${c.id}', '${c.name}')" class="folder-item cursor-pointer px-4 py-2 hover:bg-blue-50 text-slate-600 text-xs font-medium flex items-center gap-2 transition group border-l-4 border-transparent hover:border-cpi-500"><i class="far fa-folder text-yellow-500 group-hover:scale-110 transition"></i><span class="truncate">${c.name}</span></div>`).join('')}</div></div>`).join(''); if(driveStructure.length > 0 && driveStructure[0].children.length > 0) loadDriveFolder(driveStructure[0].children[0].id, driveStructure[0].children[0].name); }
        function loadDriveFolder(id, name) {
            document.getElementById('driveFolderTitle').innerText = name; document.getElementById('driveExternalLink').href = `https://drive.google.com/drive/folders/${id}?usp=drive_link`;
            document.querySelectorAll('.folder-item').forEach(el => { if(el.innerText.includes(name)) el.classList.add('bg-blue-50','text-cpi-700','border-cpi-500'); else el.classList.remove('bg-blue-50','text-cpi-700','border-cpi-500'); });
            const f = document.getElementById('driveFrame'); f.classList.add('hidden'); document.getElementById('driveLoader').classList.remove('hidden');
            f.src = `https://drive.google.com/embeddedfolderview?id=${id}#list`; f.onload = () => { document.getElementById('driveLoader').classList.add('hidden'); f.classList.remove('hidden'); };
        }
        window.onclick = function(e) { if(e.target==document.getElementById('programModal')) closeModal(); if(e.target==document.getElementById('guideModal')) closeGuide(); }
    </script>
</body>
</html>
